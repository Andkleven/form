const {
  openBrowser,
  goto,
  textBox,
  press,
  write,
  click,
  closeBrowser,
  waitFor,
  clear,
  focus,
  attach,
  to,
  fileField,
  checkBox,
  text,
  below,
  button
} = require("taiko");

const login = async () => {
  await openBrowser({ headless: false });
  await goto("http://localhost:3000/");
  await press("Tab");
  await write("admin");
  await press("Tab");
  await write("admin");
  await press("Enter");
};

const select = async (option, label, selector) => {
  await click(label, selector);
  await press("Tab");
  await press("Tab");
  await write(option);
  await press("Enter");
};

const writeSelect = async (option, label) => {
  await click(label);
  await press("Tab");
  await press("Tab");
  await write(option);
  await press("Enter");
};

const png = __dirname + "/dummies/dummy.png"
// const jpg = __dirname + "/dummies/dummy.jpg"
// const pdf = __dirname + "/dummies/dummy.pdf"

const description = async (geometry) => {
  await select(geometry, "Geometry");
  await write(`${geometry} Description`, textBox("Description name(Coating)/Material number(Packer)"));
  await select("Report Code - Hours","Additional information");
  await write("Report Code - Hours");

  await attach(
    png,
    to(
      fileField(
        { id: "File Upload" },
        {
          selectHiddenElements: true
        }
      )
    )
  );
  await click("Submit");
  await waitFor(5000)
}

const leadEngineer = async (geometry) => {
  await click("Open all homogenous items");

  // Steel Preparation
  await waitFor(5000);
  await select("Carbon", "Steel");
  await select("Crit", "Blast Media");
  await select("Primer 1", "Primer 1");
  await select("Primer 2", "Primer 2");
  await select("Soap", "Item Rubber Cement Before Coating");
  
  await click("Submit")
  await waitFor(5000)
  
  // Coating and Visualization
  await write("2", textBox("Measurement Points"));
  if ("coatedItem" === geometry) {
    await select("OD", "TDV (Target Description Value)");
    await write("100");
    await press("Enter");
    await write("1");
    await press("Enter");
    await write("100");
    await press("Enter");
    await write("2");    
  }
  await write("10", textBox("Ordered Total Rubber Thickness"));
  await press("Enter");
  await write("0");
  await press("Enter");
  await write("10");
  if ("coatedItem" === geometry) {
    await click("Add Item Rubber Cement")
    await write("10", textBox("Item Rubber Cement"));
  }
  // Step 1
  await select("Hot Air", "Vulcanization Option");
  await write("1337", textBox("Program Number"));
  await write("2", textBox("Number of Layers"));
  await waitFor(50);

  // Layer 1 - Layers need work after adding indexes!
  await select("73165 3mm", "Compound Number");
  await write("4", textBox("Applied Thickness"));
  await write("0", textBox("Shrink"));

  await press("Enter");
  await press("Enter");
  // Layer 2
  await write("73165 3mm");
  await press("Enter");
  await write("6");
  await press("Enter");
  await write("5");

  await click("Submit")
  await waitFor(5000)

  // Final Inspection
  await write("123", textBox("Hardness of Outer Layer"));
  await write("1", textBox("Number of Hardness of Outer Layer"));
  await write("123", textBox("Identification Marking"));
  await write("123", textBox("Peel Test"));
  await write("1", textBox("Number of Peel Test"));
  await checkBox("Spark Test").check();
  await click("Advanced Final Dimensions Check");
  await write("Ref B", textBox("Final Dimensions Reference"));
  await press("Enter");
  await write("10");
  await press("Enter");
  await write("11");
  
  await click("Submit");
  await waitFor(5000)
  
  await click("Back");
  await waitFor(5000)
}

const enterDate = async () => {
  await press("Space");
  await press("Enter");
}

const firstFieldDate = async () => {
  await focus(button('Batch'))
  await press("Tab")
  await press("Space");
  await press("Enter");
}

const forLoopField = async (field, number, date=false) => {
  for (let i = 0; i < number; i++) {
    await press("Enter");
    if (date) {
      await enterDate()
    } else {
      await write(field);
    }
  }
}


const operatorQC = async (geometry, unique=false, step2=false) => {
  if ("coatedItem" === geometry) {
    // Actual Steel 
    await click("Submit")
    await waitFor(5000)
  }
  
  if (!unique) {
    // Media Blastin
    await write("20", textBox("Relative Humidity"));
    await forLoopField("22", 5)
    await forLoopField("", 3, true)
    await forLoopField("100", 1)
    
    await click("Submit")
    await waitFor(5000)
  }

  if ("coatedItem" === geometry) {
    // Media Blasting Additional Tests
    await write("10", textBox("Soluble Salt Level"));
    await forLoopField("2108", 1)
    await forLoopField("", 1, true)
    await forLoopField("55", 2)
    await forLoopField("", 2, true)

    await click("Submit")
    await waitFor(5000)
  }

  // Priming 1
  await write("10", textBox("Batch Number"));
  await forLoopField("", 2, true)

  await click("Submit")
  await waitFor(5000)

  // Priming 2
  await write("10", textBox("Batch Number"));
  await forLoopField("", 2, true)

  await click("Submit")
  await waitFor(5000)

  // Item Rubber Cement Before Coating
  await firstFieldDate()
  await forLoopField("", 2, true)

  await click("Submit")
  await waitFor(5000)
  
  // coating 1
  if ("coatedItem" === geometry) {
    await firstFieldDate()
    await forLoopField("6", 1)
    await forLoopField("", 1, true)
    await forLoopField("112", 2)
    await forLoopField("", 1, true)
  } else {
    await write("4", textBox("Rubber Thickness"));
    await forLoopField("", 2, true)
  }
  await click("Submit")
  await waitFor(5000)
  
  // coating 2
  if ("coatedItem" === geometry) {
    await write("4", textBox("Rubber Thickness"));
    await forLoopField("", 1, true)
    await forLoopField("112", 2)
    await forLoopField("", 1, true)
  } else {
    await write("4", textBox("Rubber Thickness"));
    await forLoopField("", 2, true)
  }
  await click("Submit")
  await waitFor(5000)

  // Vulcanization
  await write("12052222", textBox("Autoclave Number"));
  await press("Enter");
  await forLoopField("", 2, true)

  await click("Submit")
  await waitFor(5000)

  if (step2) {
    // Measurement after Vulcanization
    if ("coatedItem" === geometry) {
    await write("4", textBox("Measurement Point Reference: 1"));
    await write("4", textBox("Measurement Point Reference: 2"));
    } else {
      await write("4", textBox("Measurement Point 1"));
      await write("4", textBox("Measurement Point 2"));
    }

    // coating 3
  if ("coatedItem" === geometry) {
    await write("4", textBox("Rubber Thickness"));
    await forLoopField("", 1, true)
    await forLoopField("112", 2)
    await forLoopField("", 1, true)
  } else {
    await write("4", textBox("Rubber Thickness"));
    await forLoopField("", 2, true)
  }
  await click("Submit")
  await waitFor(5000)
  
  // coating 4
  if ("coatedItem" === geometry) {
    await write("4", textBox("Rubber Thickness"));
    await forLoopField("", 1, true)
    await forLoopField("112", 2)
    await forLoopField("", 1, true)
  } else {
    await write("4", textBox("Rubber Thickness"));
    await forLoopField("", 2, true)
  }
  await click("Submit")
  await waitFor(5000)

  // Vulcanization 2
  await write("12052222", textBox("Autoclave Number"));
  await press("Enter");
  await forLoopField("", 2, true)

  await click("Submit")
  await waitFor(5000)
  }

  // Touch-Up
  await checkBox("Touch-Up").check();
  await focus(button('Batch'))
  await press("Tab")
  await press("Tab")
  await press("Tab")
  await enterDate()

  await click("Submit")
  await waitFor(5000)

  // Final Inspection
  if ("coatedItem" === geometry) {
    await write("110", textBox("Measurement Point Reference: 1"));
    await write("110", textBox("Measurement Point Reference: 2"));
  } else {
    await write("20", textBox("Measurement Point 1"));
    await write("20", textBox("Measurement Point 2"));
  }
  await checkBox("Identification Marking").check();
  await write("110", textBox("Hardness Of Outer Layer: 1"));
  await forLoopField("10", 2)

  await click("Submit")
  await waitFor(4000)
  
  await click("Back")
}

const operator = async (
  projectName = "Test Project"
) => {

  // try {
    // Login
    // await login(); 

    await click(`projectNumber ∙ ${projectName}`)
    await click("Coated Item Description")
    await click("ItemID3")
    await waitFor(5000)

    await operatorQC("coatedItem")

    await waitFor(3000)
    await click(`projectNumber ∙ ${projectName}`)
    await waitFor(1000)
    await click("Coated Item Description")
    await waitFor(1000)
    await click("ItemID2")
    await waitFor(5000)

    await operatorQC("coatedItem", false, true)
    
    await waitFor(3000)
    await click(`projectNumber ∙ ${projectName}`)
    await waitFor(1000)
    await click("Coated Item Description")
    await waitFor(1000)
    await click("ItemID1")
    await waitFor(5000)

    await operatorQC("coatedItem", true)

    await click(`projectNumber ∙ ${projectName}`)
    await click("Mould Description")
    await click("ItemID8")
    await waitFor(5000)

    await operatorQC("mould")

    await click(`projectNumber ∙ ${projectName}`)
    await click("Mould Description")
    await click("ItemID7")
    await waitFor(5000)

    await operatorQC("mould", false, true)

    await click(`projectNumber ∙ ${projectName}`)
    await click("Mould Description")
    await click("ItemID6")
    await waitFor(5000)

    await operatorQC("mould", true)

    
    

  // } catch (error) {
  //   console.error(error);
  // } finally {
  //   await closeBrowser();
  // }
};

const eidtItem = async (item) => {
  await click(item)
  await waitFor(1000)
  await click("Edit all")
  await waitFor(2000)
  await press("Tab");
  await press("Space");
  await waitFor(1000)
  await click("Submit")
  await waitFor(5000)
  await click("Back")
  await waitFor(5000)
}

const eidtItemAddStep = async (item) => {
  await click(item)
  await waitFor(1000)
  await click("Edit all", below("Steel Preparation"))
  await waitFor(2000)
  await click("Add step")
  await write("Hot Air", textBox({id: "react-select-8-input"}))
  await press("Enter");
  await write("2", textBox({id: "custom-number-Program Number-1"}))
  await write("2", textBox({id: "custom-number-Number of Layers-1"}))
  await waitFor(50)
  await forLoopField("7", 3)
  await press("Enter");
  await forLoopField("7", 3)
  await click("Submit")
  await waitFor(5000)
  await click("Back")
  await waitFor(5000)
}

const create = async (
  projectName = "Test Project",
  descriptionItems = 5,
  geometries = ["mould", "coatedItem"]
) => {
  const items = descriptionItems * geometries.length;
  const itemIndexes = Array.from(Array(items).keys());

  try {
    // Login
    await login();

    // Create Project
    await waitFor("Create new project");
    await click("Create new project");
    await waitFor(3000);
    await write("projectNumber", textBox({id: "custom-no-type-Project Number/PO number-0,0"}));
    await write(projectName, textBox("Project Name"));
    await write("Client", textBox("Client"));
    await select("Finn Gustavsen", "Project Manager");
    await writeSelect("Project Lead", "Project Lead");
    await writeSelect("Supervising Engineer", "Supervising Engineer");
    await writeSelect("Supervisor", "Supervisor");
    await writeSelect("Quality Control", "Quality Control");
    await write(geometries.length, textBox("Number of Descriptions"));
    await write(items, textBox("Total Number of Items"));
    await click("Submit");
    await waitFor(5000)

    // Description (Coated Item)
    if (geometries.includes("coatedItem")) {
      await description("Coated Item")

      // Add items

      let itemIds1 = [];
      for (const index of itemIndexes) {
        if (index < Math.floor(items / geometries.length)) {
          itemIds1.push(`ItemID${index + 1}`);
        }
      }

      await focus(textBox({ id: "custom-undefined-Item ID-undefined" }));

      for (const itemId of itemIds1) {
        await clear();
        await write(itemId);
        await press("Enter");
      }

      await leadEngineer("coatedItem")
      await eidtItem("itemID1")
      await eidtItemAddStep("itemID2")
      
}

      await click("Next");

    // Description (Mould)
    if (geometries.includes("mould")) {
      await description("Mould")

      // Add items
      let itemIds2 = [];
      for (const index of itemIndexes) {
        if (Math.floor(items / geometries.length) <= index) {
          itemIds2.push(`ItemID${index + 1}`);
        }
      }

      await focus(textBox({ id: "custom-undefined-Item ID-undefined" }));

      for (const itemId of itemIds2) {
        await clear();
        await write(itemId);
        await press("Enter");
      }

      await leadEngineer("mould")
      await click("Next");
      await waitFor(1000)
      
      await eidtItem("itemID6")
      await click("Next");
      await waitFor(1000)
      await eidtItemAddStep("itemID7")


    }
    await click("Send to production");
    await waitFor(5000)


    await operator()

  } catch (error) {
    console.error(error);
  } finally {
    await closeBrowser();
  }
};


exports.create = create;
exports.operator = operator;
